{% extends 'base.html' %} {% load static %} {% load custom_filters %} {% block title %}{{ game.title }} | GameForge{% endblock %} {% block extra_css %}
<style>
  .generation-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.7);
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    z-index: 9999;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.3s, visibility 0.3s;
    overflow: hidden;
  }

  .generation-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  .particles-container {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: -1;
    overflow: hidden;
  }

  .particle {
    position: absolute;
    border-radius: 50%;
    opacity: 0.7;
    animation: float 3s linear infinite;
    box-shadow: 0 0 10px 2px rgba(255, 255, 255, 0.5);
  }

  @keyframes float {
    0% {
      transform: translateY(0) translateX(0) scale(1);
      opacity: 0;
    }
    10% {
      opacity: 0.7;
    }
    90% {
      opacity: 0.7;
    }
    100% {
      transform: translateY(-100px) translateX(var(--translateX, 30px)) scale(0);
      opacity: 0;
    }
  }

  .spinner {
    border: 5px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top: 5px solid #fff;
    width: 70px;
    height: 70px;
    animation: spin 1s linear infinite;
    margin-bottom: 20px;
  }

  .progress-bar {
    width: 300px;
    height: 10px;
    background-color: rgba(255, 255, 255, 0.2);
    border-radius: 5px;
    overflow: hidden;
    margin-bottom: 15px;
  }

  .progress-bar-inner {
    height: 100%;
    width: 0%;
    background-color: #0ea5e9;
    transition: width 0.5s ease;
  }

  @keyframes spin {
    0% {
      transform: rotate(0deg);
    }
    100% {
      transform: rotate(360deg);
    }
  }

  .generation-message {
    color: white;
    text-align: center;
    max-width: 400px;
    font-size: 1.1rem;
    margin-bottom: 10px;
  }

  .generation-status {
    color: #38bdf8;
    font-size: 0.9rem;
    margin-bottom: 30px;
  }

  .creative-suggestion {
    color: #a5f3fc;
    text-align: center;
    max-width: 450px;
    font-size: 0.95rem;
    font-style: italic;
    padding: 15px;
    border-radius: 8px;
    background-color: rgba(255, 255, 255, 0.1);
    backdrop-filter: blur(4px);
    opacity: 0;
    transition: opacity 0.5s ease;
  }

  /* Animation pour faire pulser la couleur de fond des suggestions */
  @keyframes pulse {
    0% {
      background-color: rgba(14, 165, 233, 0.05);
    }
    50% {
      background-color: rgba(14, 165, 233, 0.15);
    }
    100% {
      background-color: rgba(14, 165, 233, 0.05);
    }
  }

  .creative-suggestion {
    animation: pulse 3s infinite ease-in-out;
  }
</style>
{% endblock %} {% block content %}
<div class="max-w-4xl mx-auto">
  <div class="mb-6 flex items-center">
    <a href="{% url 'games:game_list' %}" class="text-blue-600 hover:underline inline-flex items-center mr-4">
      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-1" viewBox="0 0 20 20" fill="currentColor">
        <path
          fill-rule="evenodd"
          d="M9.707 16.707a1 1 0 01-1.414 0l-6-6a1 1 0 010-1.414l6-6a1 1 0 011.414 1.414L5.414 9H17a1 1 0 110 2H5.414l4.293 4.293a1 1 0 010 1.414z"
          clip-rule="evenodd"
        />
      </svg>
      Retour
    </a>
    {% if game.creator == request.user %}
    <span class="ml-auto text-sm text-gray-500">
      <span class="inline-block px-2 py-1 {% if game.is_public %}bg-green-100 text-green-800{% else %}bg-gray-100 text-gray-800{% endif %} rounded">
        {% if game.is_public %}Public{% else %}Privé{% endif %}
      </span>
    </span>
    {% endif %}
  </div>

  <div class="bg-white shadow-md rounded-lg overflow-hidden">
    <div class="p-6">
      <h1 class="text-3xl font-bold mb-2">{{ game.title }}</h1>

      <div class="flex items-center gap-2 mb-4">
        <div class="flex flex-wrap gap-2">
          <span class="inline-block px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium"> {{ game.get_genre_display }} </span>
          <span class="inline-block px-3 py-1 bg-purple-100 text-purple-800 rounded-full text-sm font-medium"> {{ game.get_ambiance_display }} </span>
          {% with keywords=game.keywords|split:"," %} {% for keyword in keywords %} {% if keyword|striptags|trim %}
          <span class="inline-block px-3 py-1 bg-gray-100 text-gray-800 rounded-full text-sm"> {{ keyword|striptags|trim }} </span>
          {% endif %} {% endfor %} {% endwith %}
        </div>

        <!-- Bouton Favoris -->
        {% if user.is_authenticated and user != game.creator %}
        <a
          href="{% url 'games:toggle_favorite' slug=game.slug %}"
          class="ml-auto inline-flex items-center p-2 {% if user in game.favorited_by.all %}text-red-500{% else %}text-gray-400 hover:text-red-500{% endif %} transition"
        >
          <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor">
            <path
              fill-rule="evenodd"
              d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z"
              clip-rule="evenodd"
            />
          </svg>
        </a>
        {% endif %}
      </div>

      <div class="mb-6">
        <p class="text-gray-700">{{ game.description }}</p>
      </div>

      {% if game.cultural_references %}
      <div class="mb-6">
        <h2 class="text-xl font-semibold mb-2">Références culturelles</h2>
        <p class="text-gray-700">{{ game.cultural_references }}</p>
      </div>
      {% endif %}

      <div class="text-sm text-gray-500 mb-4">
        <p>Créé par {{ game.creator.username }} le {{ game.created_at|date:"d/m/Y à H:i" }}</p>
        {% if game.updated_at != game.created_at %}
        <p>Dernière modification le {{ game.updated_at|date:"d/m/Y à H:i" }}</p>
        {% endif %}
      </div>
    </div>

    {% if game.creator == request.user %}
    <div class="border-t border-gray-200 px-6 py-4 bg-gray-50 flex justify-between">
      <div class="flex items-center">
        <input type="checkbox" id="with_images" name="with_images" checked class="h-4 w-4 text-blue-600 rounded" />
        <label for="with_images" class="ml-2 text-sm text-gray-700">Générer également des images</label>
      </div>
      <button
        id="generate-btn"
        class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2"
      >
        Générer du contenu
      </button>
    </div>

    <!-- Overlay d'animation pour la génération -->
    <div id="generation-overlay" class="generation-overlay">
      <div class="particles-container"></div>
      <div class="spinner"></div>
      <div class="progress-bar" style="display: none">
        <div id="progress-bar-inner" class="progress-bar-inner"></div>
      </div>
      <div id="generation-message" class="generation-message">Génération de l'univers de jeu en cours...</div>
      <div id="generation-status" class="generation-status">Merci de patienter quelques instants</div>

      <div id="creative-suggestion" class="creative-suggestion"></div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const checkbox = document.getElementById("with_images");
        const generateBtn = document.getElementById("generate-btn");
        const overlay = document.getElementById("generation-overlay");
        const generationMessage = document.getElementById("generation-message");
        const generationStatus = document.getElementById("generation-status");
        const creativeSuggestionElement = document.getElementById("creative-suggestion");

        // Masquer la barre de progression
        document.querySelector(".progress-bar").style.display = "none";

        let withImages = checkbox.checked ? "true" : "false";

        checkbox.addEventListener("change", function () {
          withImages = this.checked ? "true" : "false";
        });

        // Création des particules (conserver cette partie qui est visuellement agréable)
        const particlesContainer = document.querySelector(".particles-container");
        const particleCount = 30; // Nombre de particules

        for (let i = 0; i < particleCount; i++) {
          createParticle(particlesContainer);
        }

        function createParticle(container) {
          const particle = document.createElement("div");
          particle.classList.add("particle");

          // Position aléatoire
          const posX = Math.random() * 100;
          const posY = Math.random() * 100;

          // Taille aléatoire
          const size = Math.random() * 6 + 2;

          // Durée aléatoire
          const duration = Math.random() * 3 + 2;

          // Direction aléatoire
          const translateX = (Math.random() - 0.5) * 100;

          // Couleur aléatoire
          const colors = ["#38bdf8", "#60a5fa", "#a5f3fc", "#7dd3fc", "#e0f2fe"];
          const color = colors[Math.floor(Math.random() * colors.length)];

          // Appliquer les styles
          particle.style.left = `${posX}%`;
          particle.style.top = `${posY}%`;
          particle.style.width = `${size}px`;
          particle.style.height = `${size}px`;
          particle.style.background = color;
          particle.style.animationDuration = `${duration}s`;
          particle.style.setProperty("--translateX", `${translateX}px`);

          container.appendChild(particle);

          // Relancer la particule après son animation
          setTimeout(() => {
            particle.remove();
            createParticle(container);
          }, duration * 1000);
        }

        // Liste de suggestions créatives à afficher pendant la génération
        const creativeSuggestions = [
          "Pensez à intégrer un arc narratif inattendu dans votre histoire...",
          "Un bon antagoniste a souvent des motivations compréhensibles...",
          "Les meilleurs jeux combinent familiarité et innovation...",
          "Considérez comment l'environnement influence le gameplay...",
          "Un système de progression bien pensé garde les joueurs engagés...",
          "Les personnages mémorables ont souvent des faiblesses marquées...",
          "Le worldbuilding se fait par petites touches, pas seulement par exposition...",
          "Pensez aux émotions que vous souhaitez provoquer chez le joueur...",
          "Un bon level design guide subtilement le joueur sans qu'il s'en aperçoive...",
          "La musique et l'ambiance sonore sont essentielles à l'immersion...",
          "L'équilibre entre défi et récompense est crucial pour l'expérience de jeu...",
          "Les meilleurs jeux permettent plusieurs façons d'atteindre un objectif...",
          "Le rythme du jeu devrait alterner entre tension et détente...",
          "N'oubliez pas que les mécaniques de jeu doivent servir l'histoire, et inversement...",
          "Les petits détails environnementaux enrichissent considérablement l'univers...",
          "Un système de combat satisfaisant est souvent simple à comprendre mais difficile à maîtriser...",
        ];

        // Fonction pour afficher une nouvelle suggestion créative
        const showNewSuggestion = function () {
          creativeSuggestionElement.style.opacity = 0;

          setTimeout(function () {
            const suggestionIndex = Math.floor(Math.random() * creativeSuggestions.length);
            creativeSuggestionElement.textContent = creativeSuggestions[suggestionIndex];
            creativeSuggestionElement.style.opacity = 1;
          }, 500);
        };

        generateBtn.addEventListener("click", function () {
          // Activer l'overlay
          overlay.classList.add("active");

          // Définir un message simple
          generationMessage.textContent = "Génération de l'univers de jeu en cours...";
          generationStatus.textContent = "Merci de patienter quelques instants";

          // Démarrer les suggestions créatives
          showNewSuggestion();
          const suggestionInterval = setInterval(showNewSuggestion, 5000);

          // Simuler un délai avant la redirection
          setTimeout(function () {
            // Redirection après un délai
            window.location.href = "{% url 'generator:generate_game_content' game_id=game.id %}?with_images=" + withImages;
          }, 3000); // 3 secondes de délai pour voir l'animation
        });
      });
    </script>
    {% endif %}
  </div>

  <div class="mt-8">
    <h2 class="text-2xl font-bold mb-4">Contenu du jeu</h2>

    {% if game.detail.universe_description or game.detail.plot or game.detail.act1 or game.characters.exists or game.locations.exists %}
    <!-- Onglets pour naviguer entre les différentes sections -->
    <div class="border-b border-gray-200 mb-4">
      <nav class="flex space-x-8" aria-label="Tabs">
        <button onclick="showTab('universe')" id="tab-universe" class="tab-btn py-4 px-1 border-b-2 border-blue-500 font-medium text-sm text-blue-600">
          Univers & Histoire
        </button>
        <button
          onclick="showTab('characters')"
          id="tab-characters"
          class="tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300"
        >
          Personnages
        </button>
        <button
          onclick="showTab('locations')"
          id="tab-locations"
          class="tab-btn py-4 px-1 border-b-2 border-transparent font-medium text-sm text-gray-500 hover:text-gray-700 hover:border-gray-300"
        >
          Lieux
        </button>
      </nav>
    </div>

    <!-- Contenu de l'univers et de l'histoire -->
    <div id="content-universe" class="tab-content bg-white shadow-md rounded-lg p-6">
      {% if game.detail.universe_description %}
      <div class="mb-6">
        <h3 class="text-xl font-semibold mb-2">L'univers du jeu</h3>
        <div class="prose max-w-none">{{ game.detail.universe_description|linebreaks }}</div>
      </div>
      {% endif %} {% if game.detail.plot %}
      <div class="mb-6">
        <h3 class="text-xl font-semibold mb-2">Intrigue principale</h3>
        <div class="prose max-w-none">{{ game.detail.plot|linebreaks }}</div>
      </div>
      {% endif %} {% if game.detail.act1 or game.detail.act2 or game.detail.act3 %}
      <div>
        <h3 class="text-xl font-semibold mb-2">Structure en trois actes</h3>

        {% if game.detail.act1 %}
        <div class="mb-4">
          <h4 class="font-semibold text-lg">Acte I</h4>
          <div class="prose max-w-none">{{ game.detail.act1|linebreaks }}</div>
        </div>
        {% endif %} {% if game.detail.act2 %}
        <div class="mb-4">
          <h4 class="font-semibold text-lg">Acte II</h4>
          <div class="prose max-w-none">{{ game.detail.act2|linebreaks }}</div>
        </div>
        {% endif %} {% if game.detail.act3 %}
        <div>
          <h4 class="font-semibold text-lg">Acte III</h4>
          <div class="prose max-w-none">{{ game.detail.act3|linebreaks }}</div>
        </div>
        {% endif %}
      </div>
      {% endif %}
    </div>

    <!-- Contenu des personnages -->
    <div id="content-characters" class="tab-content bg-white shadow-md rounded-lg p-6 hidden">
      {% if game.characters.exists %}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        {% for character in game.characters.all %}
        <div class="border rounded-lg p-4 hover:shadow-md transition">
          <h3 class="text-xl font-semibold mb-2">{{ character.name }}</h3>
          <p class="text-sm font-medium text-blue-600 mb-2">{{ character.role }}</p>

          {% if character.image %}
          <img src="{{ character.image.url }}" alt="{{ character.name }}" class="w-full object-cover rounded-md mb-4" />
          {% endif %}

          <div class="mb-3">
            <h4 class="font-semibold text-gray-700">Histoire</h4>
            <p class="text-gray-600">{{ character.background|linebreaks }}</p>
          </div>

          <div>
            <h4 class="font-semibold text-gray-700">Capacités</h4>
            <p class="text-gray-600">{{ character.abilities|linebreaks }}</p>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-gray-500 text-center py-4">Aucun personnage n'a encore été créé pour ce jeu.</p>
      {% endif %}
    </div>

    <!-- Contenu des lieux -->
    <div id="content-locations" class="tab-content bg-white shadow-md rounded-lg p-6 hidden">
      {% if game.locations.exists %}
      <div class="grid grid-cols-1 gap-6">
        {% for location in game.locations.all %}
        <div class="border rounded-lg p-4 hover:shadow-md transition">
          <h3 class="text-xl font-semibold mb-2">{{ location.name }}</h3>

          {% if location.image %}
          <img src="{{ location.image.url }}" alt="{{ location.name }}" class="w-full object-cover rounded-md mb-4" />
          {% endif %}

          <div>
            <p class="text-gray-600">{{ location.description|linebreaks }}</p>
          </div>
        </div>
        {% endfor %}
      </div>
      {% else %}
      <p class="text-gray-500 text-center py-4">Aucun lieu n'a encore été créé pour ce jeu.</p>
      {% endif %}
    </div>

    {% else %} {% if game.creator == request.user %}
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6 text-center">
      <h3 class="text-lg font-semibold mb-2 text-yellow-800">Contenu non généré</h3>
      <p class="text-yellow-700 mb-4">Vous n'avez pas encore généré de contenu pour ce jeu.</p>
      <a href="#" class="inline-block px-4 py-2 bg-yellow-600 text-white rounded-md hover:bg-yellow-700"> Générer du contenu maintenant </a>
    </div>
    {% else %}
    <div class="bg-gray-100 border border-gray-200 rounded-lg p-6 text-center">
      <p class="text-gray-600">Aucun contenu n'a encore été généré pour ce jeu.</p>
    </div>
    {% endif %} {% endif %}
  </div>
</div>
{% endblock %}
